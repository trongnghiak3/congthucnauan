<form
    id="add-recipe-form"
    method="POST"
    enctype="multipart/form-data"
    class="space-y-10 p-6 rounded-xl shadow-md h-full"
    data-recipe-id="<%= typeof recipe !== 'undefined' && recipe ? recipe.id_chinh : '' %>"
>
    <!-- B∆Ø·ªöC 1 -->
    <section id="step1" class="grid grid-cols-1 md:grid-cols-2 gap-8">
    <!-- B√äN TR√ÅI -->
    <div class="space-y-6">
      <div class="flex items-center justify-between">

         <!-- H√¨nh ·∫£nh -->
        <div>
            <img id="image_preview"
                src="<%= recipe?.hinh_anh || '/default.jpg' %>"
                class="mt-2 w-40 h-40 object-cover rounded-lg border cursor-pointer"
                onclick="document.getElementById('hinh_anh').click()" />
            <input type="file" id="hinh_anh" name="hinh_anh" accept="image/*" class="hidden" />
        </div>

        <!-- Video -->
        <div>
            <video id="video_preview"
                src="<%= recipe?.video_url || '' %>"
                controls
                class="mt-2 w-64 h-36 rounded-lg border cursor-pointer"
                onclick="document.getElementById('video_file').click()">
            </video>
            <input type="file" id="video_file" name="video_file" accept="video/mp4" class="hidden" />
        </div>
       </div>

        <!-- T√™n C√¥ng Th·ª©c -->
        <div>
            <label for="ten_ct" class="block text-sm font-semibold text-yellow-600">üìå T√™n C√¥ng Th·ª©c</label>
            <input type="text" name="ten_ct" id="ten_ct" value="<%= recipe ? recipe.ten_ct : '' %>" class="mt-2 w-full p-2 border rounded-lg" required />
        </div>

        <!-- M√¥ T·∫£ -->
        <div>
            <label for="mo_ta" class="block text-sm font-semibold text-yellow-600">üìù M√¥ T·∫£</label>
            <textarea name="mo_ta" id="mo_ta" rows="3" class="mt-2 w-full p-2 border rounded-lg " required><%= recipe ? recipe.mo_ta : '' %></textarea>
        </div>

        <!-- Th·ªùi gian - ƒê·ªô kh√≥ - S·ªë ph·∫ßn ƒÉn -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label for="thoi_gian_nau" class="block text-sm font-semibold text-yellow-600">‚è± Th·ªùi Gian (ph√∫t)</label>
                <input type="number" name="thoi_gian_nau" id="thoi_gian_nau" value="<%= recipe ? recipe.thoi_gian_nau : '' %>" class="mt-2 w-full p-2 border rounded-lg" required />
            </div>
            <div>
                <label for="do_kho" class="block text-sm font-semibold text-yellow-600">üìä ƒê·ªô Kh√≥</label>
                <select name="do_kho" id="do_kho" class="mt-2 w-full p-2 border rounded-lg" required>
                    <option value="D·ªÖ" <%= recipe && recipe.do_kho === 'D·ªÖ' ? 'selected' : '' %>>D·ªÖ</option>
                    <option value="Trung b√¨nh" <%= recipe && recipe.do_kho === 'Trung b√¨nh' ? 'selected' : '' %>>Trung b√¨nh</option>
                    <option value="Kh√≥" <%= recipe && recipe.do_kho === 'Kh√≥' ? 'selected' : '' %>>Kh√≥</option>
                </select>
            </div>
            <div>
                <label for="so_phan_an" class="block text-sm font-semibold text-yellow-600">üçΩ S·ªë Ph·∫ßn ƒÇn</label>
                <input type="number" name="so_phan_an" id="so_phan_an" value="<%= recipe ? recipe.so_phan_an : '' %>" class="mt-2 w-full p-2 border rounded-lg" required />
            </div>
        </div>
    </div>

    <!-- B√äN PH·∫¢I -->
    <div class="space-y-6">
        <div>
            <label class="block text-sm font-semibold text-yellow-600 mb-2">üë®‚Äçüç≥ C√°c B∆∞·ªõc N·∫•u</label>
       <div id="buoc_nau_container" class="border border-gray-300 p-3 rounded-md space-y-4 bg-gray-50">


                <% if (recipe && recipe.huong_dan) { %>
                    <% recipe.huong_dan.split('\n\n').forEach((step, index) => { %>
                        <% const [ten, moTa] = step.replace(/^B∆∞·ªõc \d+: /, '').split(' - '); %>
                        <div class="buoc_nau_item space-y-2 relative flex flex-col">
                            <div class="flex items-center space-x-2">
                                <span class="step-number font-bold text-yellow-600"><%= index + 1 %>.</span>
                                <input type="text" name="ten_buoc[]" value="<%= ten %>" placeholder="T√™n b∆∞·ªõc..." class="flex-grow p-2 border rounded-lg" required />
                                <button type="button" class="text-red-500 hover:text-red-700" onclick="removeBuocNau(this)">‚ùå</button>
                            </div>
                            <textarea name="buoc_nau[]" rows="2" placeholder="M√¥ t·∫£ b∆∞·ªõc..." class="w-full p-2 border rounded-lg" required><%= moTa %></textarea>
                        </div>
                    <% }); %>
                <% } else { %>
                    <div class="buoc_nau_item space-y-2 relative flex flex-col">
                        <div class="flex items-center space-x-2">
                            <span class="step-number font-bold text-yellow-600">1.</span>
                            <input type="text" name="ten_buoc[]" placeholder="T√™n b∆∞·ªõc..." class="flex-grow p-2 border rounded-lg" required />
                            <button type="button" class="text-red-500 hover:text-red-700" onclick="removeBuocNau(this)">‚ùå</button>
                        </div>
                        <textarea name="buoc_nau[]" rows="2" placeholder="M√¥ t·∫£ b∆∞·ªõc..." class="w-full p-2 border rounded-lg" required></textarea>
                    </div>
                <% } %>
            </div>
            <button type="button" onclick="addBuocNau()" class="mt-3 text-yellow-600 hover:text-yellow-800 font-semibold">‚ûï Th√™m b∆∞·ªõc</button>
        </div>

        <div class="text-right">
            <button type="button" id="btnNextStep" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md">‚û°Ô∏è Ti·∫øp Theo</button>
        </div>
    </div>
</section>

    <!-- B∆Ø·ªöC 2 -->
    <section id="step2" style="display:none;" class="space-y-6 border-t pt-6">
       <div>
    <label for="loai_mon" class="block text-sm font-semibold text-yellow-600 ">üçú Lo·∫°i M√≥n</label>
    <select name="loai_mon[]" id="loai_mon" multiple class="mt-2 w-full p-2 border rounded-lg h-60" required>
      <% loai_mon.forEach(lm => { %>
        <option
          value="<%= lm.id_chinh %>"
          <%= typeof selectedLoaiMon !== 'undefined' && selectedLoaiMon && selectedLoaiMon.includes(lm.id_chinh.toString()) ? 'selected' : '' %>
        >
          <%= lm.ten_loai %>
        </option>
      <% }) %>
    </select>
  </div>
        <!-- Nguy√™n li·ªáu -->
  <div id="nguyen_lieu_container" class="space-y-2">
    <% if (typeof selectedNguyenLieu !== 'undefined' && selectedNguyenLieu && selectedNguyenLieu.length > 0) { %>
      <% selectedNguyenLieu.forEach(nl => { %>
        <div class="nguyen_lieu_item flex flex-wrap items-center gap-2">
          <select name="nguyen_lieu_id[]" onchange="onNguyenLieuChange(this)" class="p-2 border rounded-lg">
            <option disabled>Ch·ªçn nguy√™n li·ªáu</option>
            <% nguyen_lieu.forEach(n => { %>
              <option
                value="<%= n.id_chinh %>"
                data-donvi="<%= n.don_vi %>"
                <%= n.id_chinh === nl.nguyen_lieu_id ? 'selected' : '' %>
              >
                <%= n.ten_nguyen_lieu %>
              </option>
            <% }) %>
            <option value="khac">Kh√°c (nh·∫≠p tay)</option>
          </select>
          <input type="text" name="ten_nguyen_lieu_khac[]" placeholder="T√™n nguy√™n li·ªáu m·ªõi" class="hidden p-2 border rounded-lg" />
          <input type="text" name="don_vi_khac[]" placeholder="ƒê∆°n v·ªã" class="hidden p-2 border rounded-lg" />
          <input type="number" name="so_luong[]" value="<%= nl.so_luong %>" placeholder="S·ªë l∆∞·ª£ng" step="0.01" class="p-2 border rounded-lg" required />
          <input type="text" name="don_vi[]" value="<%= nl.don_vi %>" placeholder="ƒê∆°n v·ªã" class="p-2 border rounded-lg" readonly />
          <input type="text" name="ghi_chu[]" value="<%= nl.ghi_chu %>" placeholder="Ghi ch√∫" class="p-2 border rounded-lg" />
          <button type="button" onclick="removeNguyenLieu(this)" class="text-red-500 hover:text-red-700 font-bold">‚ùå</button>
        </div>
      <% }); %>
    <% } else { %>
      <div class="nguyen_lieu_item flex flex-wrap items-center gap-2">
        <select name="nguyen_lieu_id[]" onchange="onNguyenLieuChange(this)" class="p-2 border rounded-lg">
          <option disabled selected>Ch·ªçn nguy√™n li·ªáu</option>
          <% nguyen_lieu.forEach(nl => { %>
            <option value="<%= nl.id_chinh %>" data-donvi="<%= nl.don_vi %>"><%= nl.ten_nguyen_lieu %></option>
          <% }) %>
          <option value="khac">Kh√°c (nh·∫≠p tay)</option>
        </select>
        <input type="text" name="ten_nguyen_lieu_khac[]" placeholder="T√™n nguy√™n li·ªáu m·ªõi" class="hidden p-2 border rounded-lg" />
        <input type="text" name="don_vi_khac[]" placeholder="ƒê∆°n v·ªã" class="hidden p-2 border rounded-lg" />
        <input type="number" name="so_luong[]" placeholder="S·ªë l∆∞·ª£ng" step="0.01" class="p-2 border rounded-lg" required />
        <input type="text" name="don_vi[]" placeholder="ƒê∆°n v·ªã" class="p-2 border rounded-lg" readonly />
        <input type="text" name="ghi_chu[]" placeholder="Ghi ch√∫" class="p-2 border rounded-lg" />
        <button type="button" onclick="removeNguyenLieu(this)" class="text-red-500 hover:text-red-700 font-bold">‚ùå</button>
      </div>
    <% } %>
  </div>
        <button type="button" onclick="addNguyenLieu()" class="mt-2 text-yellow-600 hover:text-yellow-800 font-semibold">‚ûï Th√™m nguy√™n li·ªáu</button>
        <div class="text-right">
            <button type="button" id="btnPrevStep" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold px-4 py-2 rounded-lg shadow-md">‚¨ÖÔ∏è Quay L·∫°i</button>
            <button type="submit" class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-5 py-2 rounded-lg shadow-md">üíæ L∆∞u C√¥ng Th·ª©c</button>
        </div>
    </section>
</form>